<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç V4 Weather Backtester</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        
        header { text-align: center; margin-bottom: 1.5rem; }
        
        h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88, #ffdd00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        
        .badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            background: linear-gradient(90deg, rgba(0, 217, 255, 0.2), rgba(0, 255, 136, 0.2));
            border: 1px solid #00d9ff;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #00d9ff;
        }
        
        .model-stats {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #a0aec0;
        }
        
        .model-stats span { color: #00ff88; font-weight: 600; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
        }
        
        .card-title {
            font-size: 1rem;
            color: #00d9ff;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        #map { height: 350px; border-radius: 12px; z-index: 1; }
        
        .input-row { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .input-group { flex: 1; }
        
        label { display: block; margin-bottom: 0.5rem; color: #a0aec0; font-size: 0.85rem; }
        
        input, select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
        }
        
        input:focus, select:focus { outline: none; border-color: #00d9ff; }
        
        button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            border: none;
            border-radius: 8px;
            color: #1a1a2e;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.3);
        }
        
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-top: 1rem; }
        
        .stat {
            text-align: center;
            padding: 0.75rem;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 8px;
        }
        
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #00d9ff; }
        .stat-label { font-size: 0.75rem; color: #a0aec0; margin-top: 0.25rem; }
        
        .stat.success { background: rgba(0, 255, 136, 0.15); }
        .stat.success .stat-value { color: #00ff88; }
        
        .stat.warning { background: rgba(255, 221, 0, 0.15); }
        .stat.warning .stat-value { color: #ffdd00; }
        
        #chart { height: 300px; margin-top: 1rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        th { color: #00d9ff; font-weight: 500; }
        .actual { color: #00ff88; }
        .error { color: #ff6b6b; }
        .predicted { color: #00d9ff; }
        
        .hidden { display: none; }
        
        .loading { text-align: center; padding: 2rem; color: #a0aec0; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(0, 217, 255, 0.2);
            border-top-color: #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .date-info {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            text-align: center;
            color: #00ff88;
        }
        
        footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1.5rem;
            color: #718096;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåç V4 Weather Backtester</h1>
            <span class="badge">XGBoost Model ‚Ä¢ Test MAE: 1.21¬∞C</span>
            <div class="model-stats">
                <div>üìä <span>211</span> Countries</div>
                <div>üìà <span>22</span> Features</div>
                <div>üìÖ <span>May 2024 - Dec 2025</span></div>
            </div>
        </header>
        
        <div class="grid">
            <!-- Map Panel -->
            <div class="card">
                <div class="card-title">üó∫Ô∏è Select Location</div>
                <div id="map"></div>
            </div>
            
            <!-- Controls Panel -->
            <div class="card">
                <div class="card-title">‚öôÔ∏è Backtesting Settings</div>
                
                <div class="date-info" id="date-info">
                    üìÖ Valid date range: <strong>May 16, 2024</strong> to <strong>Dec 24, 2025</strong>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="country">Country</label>
                        <select id="country">
                            <option value="">Loading countries...</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="start-date">Start Date</label>
                        <input type="date" id="start-date" min="2024-05-16" max="2025-12-24">
                    </div>
                    <div class="input-group">
                        <label for="end-date">End Date</label>
                        <input type="date" id="end-date" min="2024-05-16" max="2025-12-24">
                    </div>
                </div>
                
                <button id="btn-predict">üîç Run Backtest</button>
                
                <div id="stats" class="stats hidden">
                    <div class="stat success">
                        <div class="stat-value" id="stat-mae">--</div>
                        <div class="stat-label">MAE (¬∞C)</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="stat-rmse">--</div>
                        <div class="stat-label">RMSE (¬∞C)</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="stat-count">--</div>
                        <div class="stat-label">Records</div>
                    </div>
                    <div class="stat warning">
                        <div class="stat-value" id="stat-range">--</div>
                        <div class="stat-label">Temp Range</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results -->
        <div id="results" class="hidden" style="margin-top: 1.5rem;">
            <!-- Chart -->
            <div class="card">
                <div class="card-title">üìä Predicted vs Actual Temperature</div>
                <div id="chart"></div>
            </div>
            
            <!-- Table -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-title">üìÖ Detailed Results</div>
                <table>
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Predicted (¬∞C)</th>
                            <th>Actual (¬∞C)</th>
                            <th>Error (¬∞C)</th>
                        </tr>
                    </thead>
                    <tbody id="results-table"></tbody>
                </table>
            </div>
        </div>
        
        <div id="loading" class="card hidden" style="margin-top: 1.5rem;">
            <div class="loading">
                <div class="spinner"></div>
                <p>Running backtest...</p>
            </div>
        </div>
    </div>
    
    <footer>
        <p><strong>PM Accelerator</strong> | V4 XGBoost Weather Backtester</p>
        <p style="margin-top: 0.5rem;">Historical data analysis ‚Ä¢ May 2024 - December 2025</p>
    </footer>
    
    <script>
        // Initialize map
        const map = L.map('map').setView([25, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        
        let marker = null;
        const $ = id => document.getElementById(id);
        
        // Set default dates
        $('start-date').value = '2024-10-01';
        $('end-date').value = '2024-10-07';
        
        // Load countries
        async function loadCountries() {
            try {
                const response = await fetch('/api/countries');
                const data = await response.json();
                const select = $('country');
                select.innerHTML = '<option value="">-- Select a country --</option>';
                
                data.countries.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.name;
                    option.textContent = `${c.name} (${c.records} records)`;
                    option.dataset.lat = c.latitude;
                    option.dataset.lon = c.longitude;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Failed to load countries:', e);
            }
        }
        
        loadCountries();
        
        // Country selection updates map
        $('country').onchange = function() {
            const option = this.options[this.selectedIndex];
            if (option.dataset.lat) {
                const lat = parseFloat(option.dataset.lat);
                const lon = parseFloat(option.dataset.lon);
                map.setView([lat, lon], 5);
                
                if (marker) map.removeLayer(marker);
                marker = L.marker([lat, lon]).addTo(map);
            }
        };
        
        // Map click updates country
        map.on('click', async (e) => {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lon]).addTo(map);
            
            // Find nearest country
            const countries = $('country').options;
            let minDist = Infinity;
            let nearestIdx = 0;
            
            for (let i = 1; i < countries.length; i++) {
                const clat = parseFloat(countries[i].dataset.lat);
                const clon = parseFloat(countries[i].dataset.lon);
                const dist = Math.sqrt((lat - clat) ** 2 + (lon - clon) ** 2);
                if (dist < minDist) {
                    minDist = dist;
                    nearestIdx = i;
                }
            }
            
            $('country').selectedIndex = nearestIdx;
        });
        
        // Run backtest
        $('btn-predict').onclick = async () => {
            const country = $('country').value;
            const startDate = $('start-date').value;
            const endDate = $('end-date').value;
            
            if (!country) {
                alert('Please select a country');
                return;
            }
            
            if (!startDate) {
                alert('Please select a start date');
                return;
            }
            
            $('btn-predict').disabled = true;
            $('btn-predict').textContent = '‚è≥ Loading...';
            $('results').classList.add('hidden');
            $('loading').classList.remove('hidden');
            
            try {
                const url = `/api/predict?country=${encodeURIComponent(country)}&start_date=${startDate}&end_date=${endDate || startDate}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.detail) throw new Error(data.detail);
                
                renderResults(data);
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                $('btn-predict').disabled = false;
                $('btn-predict').textContent = 'üîç Run Backtest';
                $('loading').classList.add('hidden');
            }
        };
        
        function renderResults(data) {
            $('results').classList.remove('hidden');
            
            const summary = data.summary;
            const predictions = data.predictions;
            
            // Stats
            $('stats').classList.remove('hidden');
            $('stat-mae').textContent = summary.mae;
            $('stat-rmse').textContent = summary.rmse;
            $('stat-count').textContent = summary.count;
            $('stat-range').textContent = `${summary.min_actual}¬∞ - ${summary.max_actual}¬∞`;
            
            // Chart
            const dates = predictions.map(p => p.datetime);
            const predicted = predictions.map(p => p.predicted);
            const actual = predictions.map(p => p.actual);
            
            const traces = [
                {
                    x: dates,
                    y: predicted,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Predicted',
                    line: { color: '#00d9ff', width: 2 },
                    marker: { size: 6 }
                },
                {
                    x: dates,
                    y: actual,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Actual',
                    line: { color: '#00ff88', width: 2 },
                    marker: { size: 6 }
                }
            ];
            
            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#fff' },
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)', title: 'Date' },
                yaxis: { gridcolor: 'rgba(255,255,255,0.1)', title: 'Temperature (¬∞C)' },
                margin: { t: 20, r: 20, b: 60, l: 50 },
                legend: { x: 0, y: 1.1, orientation: 'h' },
                showlegend: true
            };
            
            Plotly.newPlot('chart', traces, layout, { responsive: true });
            
            // Table
            $('results-table').innerHTML = predictions.map(p => `
                <tr>
                    <td>${p.datetime}</td>
                    <td class="predicted"><strong>${p.predicted}¬∞C</strong></td>
                    <td class="actual">${p.actual}¬∞C</td>
                    <td class="${p.error > 2 ? 'error' : ''}">${p.error}¬∞</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
